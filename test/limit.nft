#!/usr/sbin/nft -f
# File: limit.nft
# Description: A test NFT file to exercise '[add] limit' Vim syntax highlightings.
#
# Supports following syntaxes:
#
#   [ [ 'add' ] 'rule' ] 'limit' obj_spec limit_obj limit_config close_scope_limit
#   [ [ 'add' ] 'rule' ] 'limit' obj_spec limit_obj '{' limit_block '}' close_scope_limit
#   'create' 'limit' obj_spec limit_obj limit_config close_scope_limit
#   'delete' 'limit' obj_spec
#   'delete' 'limit' objid_spec
#   'delete' 'limit' ( obj_spec | objid_spec ) 
#   [ [ 'add' ] 'rule' ] 'limit'
#   [ [ 'add' ] 'rule' ] 'limit' 'table' table_spec
#
#
################################################################################
# true positive test: properly hightlighted correctly; has good content; perfect
################################################################################

# 'limit'->'add'->add_cmd->base_cmd
# 'limit'->add_cmd->base_cmd
# identifier->table_spec->obj_spec->'limit'->add_cmd->base_cmd
# identifier->obj_spec->'limit'->add_cmd->base_cmd
# 'rate'->limit_config->'limit'->add_cmd->base_cmd
# NUM->limit_rate_pkts->'rate'->limit_config->'limit'->add_cmd->base_cmd
# SLASH->limit_rate_pkts->'rate'->limit_config->'limit'->add_cmd->base_cmd
limit myIp6Table myIp6Limit rate 1/second
limit myIp6Table myIp6Limit rate 12/second
limit myIp6Table myIp6Limit rate 123/second
limit myIp6Table myIp6Limit rate 1234/second
limit myIp6Table myIp6Limit rate 12345/second
limit myIp6Table myIp6Limit rate 123456/second
limit myIp6Table myIp6Limit rate 1234567/second
limit myIp6Table myIp6Limit rate 12345678/second
limit myIp6Table myIp6Limit rate 123456789/second
limit myIp6Table myIp6Limit rate 1234567890/second

limit myIp6Table myIp6Limit rate 1/second
limit myIp6Table myIp6Limit rate 1/ second
limit myIp6Table myIp6Limit rate 1 /second
limit myIp6Table myIp6Limit rate 1 / second
limit myIp6Table myIp6Limit rate 1 / seconds
limit myIp6Table myIp6Limit rate 1 / minute
limit myIp6Table myIp6Limit rate 1 / minutes
limit myIp6Table myIp6Limit rate 1 / hour
limit myIp6Table myIp6Limit rate 1 / hours
limit myIp6Table myIp6Limit rate 1 / day
limit myIp6Table myIp6Limit rate 1 / days
limit myIp6Table myIp6Limit rate 1 / week
limit myIp6Table myIp6Limit rate 1 / weeks 

limit myIp6Table myIp6Limit rate 1 / second;
limit myIp6Table myIp6Limit rate 1 / second; 
limit myIp6Table myIp6Limit rate 1 / second ;
limit myIp6Table myIp6Limit rate 1 / second ; 

# 'rate'->limit_config->'limit'->add_cmd->base_cmd
# limit_mode->'rate'->limit_config->'limit'->add_cmd->base_cmd
# NUM->limit_rate_pkts->'rate'->limit_config->'limit'->add_cmd->base_cmd
# SLASH->limit_rate_pkts->'rate'->limit_config->'limit'->add_cmd->base_cmd
# time_unit->limit_rate_pkts->'rate'->limit_config->'limit'->add_cmd->base_cmd
limit myIpTable myIpLimit rate over 3600000 / days
limit myIpTable myIpLimit rate over 3600000 / days;
limit myInetTable myInetLimit rate until 1/seconds

# 'rate'->limit_config->'limit'->add_cmd->base_cmd
# limit_mode->'rate'->limit_config->'limit'->add_cmd->base_cmd
# NUM->limit_rate_bytes->'rate'->limit_config->'limit'->add_cmd->base_cmd
# SLASH->limit_rate_bytes->'rate'->limit_config->'limit'->add_cmd->base_cmd
# time_unit->limit_rate_bytes->'rate'->limit_config->'limit'->add_cmd->base_cmd
# 'burst'->limit_burst_bytes->'rate'->limit_config->'limit'->add_cmd->base_cmd
# NUM->limit_burst_bytes->'rate'->limit_config->'limit'->add_cmd->base_cmd
# time_unit->limit_burst_pkts->'rate'->limit_config->'limit'->add_cmd->base_cmd
limit myNetdevTable myNetdevLimit rate 1 byte/minute
limit myNetdevTable myNetdevLimit rate 1 bytes/minute
limit myNetdevTable myNetdevLimit rate 1 kbyte/minute
limit myNetdevTable myNetdevLimit rate 1 kbytes/minute
limit myNetdevTable myNetdevLimit rate 1 Mbyte/minute
limit myNetdevTable myNetdevLimit rate 1 Mbytes/minute
limit myNetdevTable myNetdevLimit rate 1 Gbyte/minute
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute
limit myNetdevTable myNetdevLimit rate 1 Pbyte/minute
limit myNetdevTable myNetdevLimit rate 1 Pbytes/minute

limit myNetdevTable myNetdevLimit rate 1 byte/ minute
limit myNetdevTable myNetdevLimit rate 1 byte /minute
limit myNetdevTable myNetdevLimit rate 1 byte / minute

limit myNetdevTable myNetdevLimit rate 1 kbyte/second
limit myNetdevTable myNetdevLimit rate 1 kbyte/seconds
limit myNetdevTable myNetdevLimit rate 1 kbyte/minute
limit myNetdevTable myNetdevLimit rate 1 kbyte/minutes
limit myNetdevTable myNetdevLimit rate 1 kbyte/hour
limit myNetdevTable myNetdevLimit rate 1 kbyte/hours
limit myNetdevTable myNetdevLimit rate 1 kbyte/day
limit myNetdevTable myNetdevLimit rate 1 kbyte/days
limit myNetdevTable myNetdevLimit rate 1 kbyte/week
limit myNetdevTable myNetdevLimit rate 1 kbyte/weeks

limit myNetdevTable myNetdevLimit rate 1 kbyte/weeks;
limit myNetdevTable myNetdevLimit rate 1 kbyte/weeks; 
limit myNetdevTable myNetdevLimit rate 1 kbyte/weeks ;
limit myNetdevTable myNetdevLimit rate 1 kbyte/weeks ; 

limit myNetdevTable myNetdevLimit rate 1 byte/minute burst 5 byte
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 byte 
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 bytes 
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 kbyte
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 kbytes
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 Mbyte
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 Mbytes
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 GBYTE
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 GBYTES

# limit_config->obj_spec->'limit'->add_cmd->base_cmd
# limit_config->identifier->family_spec->table_spec->'limit'->add_cmd->base_cmd
limit ip6 myIp6Table myIp6Limit rate 1 / week
limit ip myIpTable myIpLimit rate 1/ day
limit inet myInetTable myInetLimit rate 1/second
limit netdev myNetdevTable myNetdevLimit rate 1/minute 
limit bridge myBridgeTable myBridgeLimit rate 1 /hour 
limit arp myBridgeTable myBridgeLimit rate 1 /hour 

# limit_burst_pkts->limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'add'->add_cmd->base_cmd
add limit myIpTable myIpLimit rate 1/second 
add limit myIpTable myIpLimit rate 1/second burst 1514 packet
add limit myIpTable myIpLimit rate 1/second burst 15 packets

# limit_burst_pkts->limit_rate_pkts->limit_config->identifier->family_spec->table_spec->'limit'->'add'->add_cmd->base_cmd
add limit ip6 myIp6Table myIp6Limit rate 1 / week burst 1 packet
add limit ip6 myIp6Table myIp6Limit rate 1 / week burst 1 packets
add limit ip myIpTable myIpLimit rate 1/ day burst 1 packet
add limit inet myInetTable myInetLimit rate 1/second burst 1 packets
add limit inet myInetTable myInetLimit rate 1/second burst 10 packets
add limit inet myInetTable myInetLimit rate 1/second burst 100000 packets
add limit inet myInetTable myInetLimit rate 1/second burst 1000000000 packets
add limit inet myInetTable myInetLimit rate 1/second burst 10000000000000 packets
add limit inet myInetTable myInetLimit rate 1/second burst 10000000000000000 packets
add limit inet myInetTable myInetLimit rate 1/second burst 10000000000000000000 packets
add limit netdev myNetdevTable myNetdevLimit rate 1/minute burst 1 packets
add limit bridge myBridgeTable myBridgeLimit rate 1 /hour burst 1T packets
add limit arp myBridgeTable myBridgeLimit rate 1 /hour burst 1000000 packets

# limit_rate_pkts->obj_spec->'limit'->'rule'->'add'->add_cmd->base_cmd
# limit_rate_pkts->identifier->table_spec->'limit'->'rule'->'add'->add_cmd->base_cmd
add limit myIp6Table myIp6Limit rate 1 / week

# [ add rule ] limit obj_spec limit_obj { limit_config } close_scope_limit
# limit_block->'{'->identifier->family_spec->table_spec->'limit'->'rule'->'add'->add_cmd->base_cmd
#limit myTable lim_400ppm { rate 400/minute ; comment "use to limit incoming icmp" ; }
#limit myTable lim_1kbps  { rate over 1024 bytes/second burst 512 bytes ; comment "use to limit incoming smtp" ; }

# limit obj_spec limit_obj { stmt_separator } close_scope_limit
limit myTable lim_400ppm { ; }

# limit obj_spec limit_obj { comment_spec } close_scope_limit
#limit myTable lim_400ppm { comment "comments here"; }

# limit obj_spec limit_obj { common_block } close_scope_limit
#limit myTable lim_400ppm { 
#    include "rate-limit.nft"
#    rate 400/minute ; comment "use to limit incoming icmp" ; 
#}

table T {
    limit L { 
        # comment line
        include "my_secret_limits.nft";
        rate 10/second 
        rate over 1/minute burst 5 packets
        rate until 3/hour burst 30 packets
        rate until 3 Mbytes/hour burst 30 bytes 
        comment "nice limits there"
    }
};

# TODO create limit
# limit_rate_pkts->limit_config->obj_spec->'limit'->'create'->add_cmd->base_cmd
# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit myIp6Table myIp6Limit rate 1 / week

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit myIpTable myIpLimit rate over 3600000/ day
create limit myInetTable myInetLimit rate until 1/second

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit myNetdevTable myNetdevLimit rate 1/minute burst 5 packets
create limit myBridgeTable myBridgeLimit rate 1 /hour 

# limit_config->obj_spec->'limit'->'create'->add_cmd->base_cmd
# limit_config->identifier->family_spec->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit ip6 myIp6Table myIp6Limit rate 1 / week
create limit ip myIpTable myIpLimit rate 1/ day
create limit inet myInetTable myInetLimit rate 1/second
create limit netdev myNetdevTable myNetdevLimit rate 1/minute 
create limit bridge myBridgeTable myBridgeLimit rate 1 /hour 
create limit arp myBridgeTable myBridgeLimit rate 1 /hour 

# TODO delete limit
# limit_rate_pkts->limit_config->obj_spec->'limit'->'delete'->add_cmd->base_cmd
# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'delete'->delete_cmd->base_cmd
delete limit myIp6Table myIp6Limit rate 1 / week

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'delete'->delete_cmd->base_cmd
delete limit myIpTable myIpLimit rate over 3600000/ day
delete limit myInetTable myInetLimit rate until 1/second

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'delete'->delete_cmd->base_cmd
delete limit myNetdevTable myNetdevLimit rate 1/minute burst 5 packets
delete limit myBridgeTable myBridgeLimit rate 1 /hour 

# limit_config->obj_spec->'limit'->'delete'->add_cmd->base_cmd
# limit_config->identifier->family_spec->table_spec->'limit'->'delete'->delete_cmd->base_cmd
delete limit ip6 myIp6Table myIp6Limit rate 1 / week
delete limit ip myIpTable myIpLimit rate 1/ day
delete limit inet myInetTable myInetLimit rate 1/second
delete limit netdev myNetdevTable myNetdevLimit rate 1/minute 
delete limit bridge myBridgeTable myBridgeLimit rate 1 /hour 
delete limit arp myBridgeTable myBridgeLimit rate 1 /hour 


# Syntax:  delete limit objid_spec
delete limit table_id handle 15
delete limit ip table_id handle 15
delete limit ip6 table_id handle 15
delete limit inet table_id handle 15
delete limit netdev table_id handle 15
delete limit bridge table_id handle 15
delete limit arp table_id handle 15


# TODO list limit
# obj_spec->'limit'->list_cmd->base_cmd
list limit table_id limit_id
list limit ip table_id limit_id
list limit ip6 table_id limit_id
list limit inet table_id limit_id
list limit netdev table_id limit_id
list limit bridge table_id limit_id
list limit arp table_id limit_id

# ruleset_spec->'limits'->'list'->list_cmd->base_cmd
list limits ip 
list limits ip6
list limits inet 
list limits netdev 
list limits bridge 
list limits arp 

# 'table'->'limits'->'list'->list_cmd->base_cmd
list limits table table_id
list limits table ip table_id
list limits table ip6 table_id
list limits table inet table_id
list limits table netdev table_id
list limits table bridge table_id
list limits table arp table_id


################################################################################
# true negative test: properly hightlighted wrongly to show an error; 
# so far, so good.
################################################################################

limitmyIp6Table myIp6Limit rate 1 / weeks 
limit myIp6TablemyIp6Limit rate 1 / weeks 
limit myIp6Table myIp6Limitrate 1 / weeks 
limit myIp6Table myIp6Limit rate1 / weeks 
limit myIp6Table myIp6Limit over rate 1 / weeks 
limit myIpTable myIpLimit rateover 3600000 / days
limit myIpTable myIpLimit rate over3600000 / days

limit myIp6Table myIp6Limit rate 12345678901/second

limit myIpTable myIpLimit rate over 3600000/weekdays
limit myIpTable myIpLimit rate over 3600000/week days
limit myIpTable myIpLimit rate over 3600000/week days;

limit myNetdevTable myNetdevLimit rate 1 bytes/minute burst 5 packets
limit myNetdevTable myNetdevLimit rate 1 kbyte/minute burst 5 packets
limit myNetdevTable myNetdevLimit rate 1 kbytes/minute burst 5 packets
limit myNetdevTable myNetdevLimit rate 1 Mbyte/minute burst 5 packets
limit myNetdevTable myNetdevLimit rate 1 Mbytes/minute burst 5 packets
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minute burst 5 packets
limit myNetdevTable myNetdevLimit rate 1 Gbytes/minutes burst 5 packets

limit myIp6Table myIp6Limit rate 1  # premature EOS
limit myIp6Table myIp6Limit rate 1 /  # premature EOS
limit myIpTable myIpLimit rate over 3600000/  # premature EOS
limit myInetTable myInetLimit rate until 1  # premature EOS
limit myBridgeTable myBridgeLimit rate 1 /hour burst 11  # premature EOS

table T {
    limit myIp6Limit {
        rate 1  # premature EOS
        rate 1 /  # premature EOS
        rate over 3600000/  # premature EOS
        rate until 1  # premature EOS
        rate 1 /hour burst 11  # premature EOS
    }
}
add limit inet myInetTable myInetLimit rate 1/second burst 100000000000000000000 packets

################################################################################
# false negative test: highlighted wrongly; still has good content; oops.
################################################################################

################################################################################
# false positive test: looks highlighted correctly; has bad content; oops.
################################################################################

