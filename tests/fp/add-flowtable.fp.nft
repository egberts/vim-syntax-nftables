################################################################################
# false positive test: looks highlighted correctly; has bad content; oops.
################################################################################


# triggered by the virtue of wildcard unquoted identifier in the
# nft_base_cmd_add_cmd_rule_position_table_spec_wildcard in 'nft_line'

flowtableTableId

table T { flowtable F { } }
table ip T { flowtable F { } }
table ip6 T { flowtable F { } }
table inet T { flowtable F { } }
table netdev T { flowtable F { } }
table bridge T { flowtable F { } }
table arp T { flowtable F { } }
table T { flowtable F { hook ABC priority -150 } }
table T { flowtable F { devices = { eth0, wlan0 } }; };
table T { flowtable F { flags offload } }

table T { flowtable F { counter } }

# flowtable_block->'{'->flowtable_spec->'flowtable'->'delete'->delete_cmd->base_cmd
delete flowtable table_id flowtable_id { hook input; devices = $MY_WAN; flags offload; counter }
delete flowtable ip table_id flowtable_id { devices = $MY_DMZ }
delete flowtable ip6 table_id flowtable_id { hook postrouting }
delete flowtable inet table_id flowtable_id { flags offload }
delete flowtable netdev table_id flowtable_id { counter }
delete flowtable bridge table_id flowtable_id { hook prerouting; devices = $WAN }
delete flowtable arp table_id flowtable_id {
    include "MyInclude." ;
    define A = 1 ;
    redefine A = 2 ;
    undefine A ;
    hook output ;
    devices = { "eth0" } ;
    flags offload ;
    counter ;
    }

list flowtable ip

# set_spec->'table'->'flow'->list_cmd->base_cmd
add table table_id
list flow table table_id last
list flow table last last
list flow table table_id last
list flow table last last
list flow table ip table_id last
list flow table ip last last
list flow table ip table_id last
list flow table ip last last
list flow table ip6 table_id last
list flow table inet table_id last

add flowtable ip6 T C { hook prerouting priority 100; };
list flowtable ip6 T C

# ->flowtable_spec->'flowtable'->'delete'->delete_cmd->base_cmd
add table netdev table_id
add table bridge table_id
add table arp table_id
add flowtable netdev table_id flowtable_id { hook ingress priority 0 ; devices = { eno2, wlo1 } ; }
add flowtable bridge table_id flowtable_id { hook ingress priority 0 ; devices = { eno2, wlo1 } ; }
add flowtable arp table_id flowtable_id { hook ingress priority 0 ; devices = { eno2, wlo1 } ; }


# flowtableid_spec->'flowtable'->'delete'->delete_cmd->base_cmd
delete flowtable table_id handle 15
delete flowtable ip table_id handle 15
delete flowtable ip6 table_id handle 15
delete flowtable inet table_id handle 15
delete flowtable netdev table_id handle 15
delete flowtable bridge table_id handle 15
delete flowtable arp table_id handle 15


table inet x {

    chain input {
        type filter hook input priority 0; policy drop;

        flowtable forward flowtable_id {
            hook prerouting priority 0
            devices = { $DEV_PRIVATE, $DEV_INTERNET }
        }


        # offload established HTTP connections
        tcp dport { 80, 443 } ct state established flow add @f counter packets 0 bytes 0

        # Allow traffic from established and related packets, drop invalid
        ct state vmap { established : accept, related : accept, invalid : drop }

        # connections from the internal net to the internet or to other
        # internal nets are allowed
        iifname $DEV_PRIVATE counter accept
    }
}
