#!/usr/sbin/nft -f
# File: destroy.nft
# Description: A test NFT file to exercise 'destroy' Vim syntax highlightings.
#
# base_cmd 'destroy' destroy_cmd 
# nft_line/nft_base_cmd/nft_base_cmd_add/nft_base_cmd_add_set
#
################################################################################
# true positive test: properly hightlighted correctly; has good content; perfect
################################################################################

# destroy table <table_spec>
# table_spec->'table'->destroy_cmd->'destroy'->base_cmd->line
destroy table T
destroy table last
destroy table ip T
destroy table ip6 T
destroy table inet T
destroy table netdev T
destroy table bridge T
destroy table arp T


# destroy chain <chainid_spec>
# common_block->chain_block->'{'->'chain'->destroy_cmd->'destroy'->base_cmd->line
add table T
add table ip Tip
add table ip6 Tip6
add table inet Tinet
add table netdev Tnetdev
add table bridge Tbridge
add table arp Tarp

create chain T C
create chain ip Tip Cip

destroy chain T C
destroy chain ip Tip Cip
destroy chain ip6 Tip6 Cip6
destroy chain inet Tinet Cinet
destroy chain netdev Tnetdev Cnetdev
destroy chain bridge Tbridge Cbridge
destroy chain arp Tarp Carp

destroy map ip Tip Mip

# destroy map <set_spec>

add table ip Tip
add table ip6 Tip6
add table inet Tinet
add table netdev Tnetdev
add table bridge Tbridge
add table arp Tarp

add map ip Tip Mip { type ipv4_addr : verdict; }
add map ip Tip Mip { type ipv4_addr : verdict; }
add map ip6 Tip6 Mip6 { type ipv6_addr : verdict; }
add map inet Tinet Minet { type ipv6_addr : verdict; }
add map netdev Tnetdev Mnetdev { type ipv6_addr : verdict; }
add map bridge Tbridge Mbridge { type ipv6_addr : verdict; }
add map arp Tarp Marp { type ipv6_addr : verdict; }

destroy map ip Tip Mip
destroy map ip6 Tip6 Mip6
destroy map inet Tinet Minet
destroy map netdev Tnetdev Mnetdev
destroy map bridge Tbridge Mbridge
destroy map arp Tarp Marp


# destroy element <set_spec> <set_block_expr>
add table T
add table ip Tip
add table ip6 Tip6
add table inet Tinet
add table netdev Tnetdev
add table bridge Tbridge
add table arp Tarp
add set T E { type ipv4_addr; policy memory; size 1490; comment "my comment string"; }
add set ip Tip Eip { type ipv4_addr; size 1490; }
add set ip6 Tip6 Eip6 { type ipv4_addr; size 1490; }
add set inet Tinet Einet { type ipv4_addr; size 1490; }
add set netdev Tnetdev Enetdev { type ipv4_addr; size 1490; }
add set bridge Tbridge Ebridge { type ipv4_addr; size 1490; }
add set arp Tarp Earp { type ipv4_addr; size 1490; }
destroy element T E { 4.4.4.4 }
destroy element ip Tip Eip { 4.4.4.4 }
destroy element ip6 Tip6 Eip6 { 4.4.4.4 }
destroy element inet Tinet Einet { 10.0.0.1 }
destroy element netdev Tnetdev Enetdev { 10.0.0.1, 127.0.0.1 }
destroy element bridge Tbridge Ebridge { 4.4.4.4 }
destroy element arp Tarp Earp { 4.4.4.4 }


# 'destroy' 'flowtable' <flowtable_spec>
# common_block->flowtable_block->'{'->'flowtable'->destroy_cmd->'destroy'->base_cmd->line
# Add tables
add table ip T
add table ip Tip
add table ip6 Tip6
# Add flowtables
add flowtable ip T FT { hook ingress priority 15; devices = { eno2 }; }
add flowtable ip Tip FTip { hook ingress priority 0; devices = { eno2 }; }
add flowtable ip6 Tip6 FTip6 { hook ingress priority 0; devices = { eno2 }; }
add flowtable inet Tinet FTinet { hook ingress priority 0; devices = { eno2 }; }
# Delete flowtables (if needed)
destroy flowtable ip T FT
destroy flowtable ip Tip FTip
destroy flowtable ip6 Tip6 FTip6
destroy flowtable inet Tinet FTinet

# destroy quota <obj_spec>
add table ip T
add table ip Tip
add table ip6 Tip6
add table inet Tinet
add table netdev Tnetdev
add table bridge Tbridge
add table arp Tarp
add quota T Q 500 mbytes
add quota ip Tip Qip over 500 mbytes
add quota ip6 Tip6 Qip6 until 500 mbytes
add quota inet Tinet Qinet until 500 mbytes
add quota netdev Tnetdev Qnetdev until 500 mbytes
add quota bridge Tbridge Qbridge until 500 mbytes
add quota arp Tarp Qarp until 500 mbytes
destroy quota T Q
destroy quota ip Tip Qip
destroy quota ip6 Tip6 Qip6
destroy quota inet Tinet Qinet
destroy quota netdev Tnetdev Qnetdev
destroy quota bridge Tbridge Qbridge
destroy quota arp Tarp Qarp

# secmark commented out here in destroy.tp.nft due to senforce=Disabled
# however, a copy remains in 'z-secmark.tp.nft' unit test.
#add table ip Tip
#add table ip6 Tip6
#add table inet Tinet
#add secmark ip Tip SMip { "system_u:object_r:ssh_server_packet_t:s0" }
#add secmark ip6 Tip6 SMip6 { "system_u:object_r:http_server_packet_t:s0" }  # fails, family_spec required
#add secmark inet Tinet SMinet { "system_u:object_r:dns_server_packet_t:s0" }
#destroy secmark ip Tip SMip
#destroy secmark ip6 Tip6 SMip6
#destroy secmark inet Tinet SMinet

add table T
add table ip Tip
add table ip6 Tip6
add table inet Tinet

add synproxy T SP mss 1500 wscale 7;
add synproxy ip Tip SPip mss 1492 wscale 5;
add synproxy ip6 Tip6 SPip6 mss 1498 wscale 6;
add synproxy inet Tinet SPinet mss 1496 wscale 4;

destroy synproxy T SP
destroy synproxy ip Tip SPip
destroy synproxy ip6 Tip6 SPip6
destroy synproxy inet Tinet SPinet


########################################################333


