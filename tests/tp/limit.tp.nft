#!/usr/sbin/nft -f
# File: limit.nft
# Description: A test NFT file to exercise '[add] limit' Vim syntax highlightings.
#
# Supports following syntaxes:
#
#   [ [ 'add' ] 'rule' ] 'limit' obj_spec limit_obj limit_config close_scope_limit
#   [ [ 'add' ] 'rule' ] 'limit' obj_spec limit_obj '{' limit_block '}' close_scope_limit
#   'create' 'limit' obj_spec limit_obj limit_config close_scope_limit
#   'delete' 'limit' obj_spec
#   'delete' 'limit' objid_spec
#   'delete' 'limit' ( obj_spec | objid_spec )
#   [ [ 'add' ] 'rule' ] 'limit'
#   [ [ 'add' ] 'rule' ] 'limit' 'table' table_spec
#
#
################################################################################
# true positive test: properly hightlighted correctly; has good content; perfect
################################################################################

# setup
add table T
add table ip Tip
add table ip6 Tip6
add table inet Tinet
add table netdev Tnetdev
add table bridge Tbridge
add table arp Tarp

# base_cmd add_cmd 'table' table_spec table_block 'limit' limit_block

table T { limit L { rate 15 bytes / second }; }
table T { limit L { rate 1 bytes / second }; }
table T { limit L { rate over 15 / second }; }
table T { limit L { rate over 15 / minute }; }
table T { limit L { rate over 15 / hour }; }
table T { limit L { rate over 15 / day }; }
table T { limit L { rate over 15 / week }; }
table T { limit L { rate over 15 bytes / second }; }
table T { limit L { rate over 15 kbytes / minute }; }
table T { limit L { rate over 15 mbytes / hour }; }

table T {
    limit L {
        rate 1 / second
        rate 1 / second burst 1 packets
        rate over 1 / second
        rate over 1 / second burst 15 packets

        rate 1 mbytes / second
        rate 1 mbytes / second burst 1 mbytes
        rate over 1 mbytes / second
        rate over 1 mbytes / second burst 15 mbytes

        # common_block
        include "../include/comment-just-a-comment.nft"
        define A = 1
        redefine A = 2
        undefine A
    }
}
table T { limit L { }; }


table T {
    set S {
        type ipv4_addr
        ct count over 15  # a maximum of one 'ct' expression per set_block
        limit rate 15 mbytes / second burst 15 kbytes  # a maximum of one 'limit' expression per set_block
    }
}


table T {
    limit L { 
        # comment line
        include "../include/comment-just-a-comment.nft";
        rate 10/second 
        rate over 1/minute burst 5 packets

    }
};

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit ip Tip Lip rate over 3600000/ day

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit ip6 Tip6 Lip6 rate 1 / week

# limit_rate_pkts->limit_config->identifier->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit inet Tinet Linet rate 1/minute burst 5 packets
create limit netdev Tnetdev Lnetdev rate 1/minute burst 5 packets
create limit bridge Tbridge Lbridge rate 1 /hour
create limit arp Tarp Larp rate 1 /hour

# limit_config->obj_spec->'limit'->'create'->add_cmd->base_cmd
# limit_config->identifier->family_spec->table_spec->'limit'->'create'->create_cmd->base_cmd
create limit ip Tip LipCreate rate 1/ day
create limit ip6 Tip6 Lip6Create rate 1 / week
create limit inet Tinet LinetCreate rate 1/second
create limit netdev Tnetdev LnetdevCreate rate 1/minute
create limit bridge Tbridge LbridgeCreate rate 1 /hour
create limit arp Tarp LarpCreate rate 1 /hour

# TODO list limit
# obj_spec->'limit'->list_cmd->base_cmd
list limit T L
list limit ip Tip Lip
list limit ip6 Tip6 Lip6
list limit inet Tinet Linet
list limit netdev Tnetdev Lnetdev
list limit bridge Tbridge Lbridge
list limit arp Tarp Larp

# ruleset_spec->'limits'->'list'->list_cmd->base_cmd
list limits
list limits ip
list limits ip6
list limits inet 
list limits netdev 
list limits bridge 
list limits arp 

# 'table'->'limits'->'list'->list_cmd->base_cmd
list limits table T
list limits table ip Tip
list limits table ip6 Tip6
list limits table inet Tinet
list limits table netdev Tnetdev
list limits table bridge Tbridge
list limits table arp Tarp


