#!/usr/sbin/nft -f
# File: delete.nft
# Description: A test NFT file to exercise 'delete' Vim syntax highlightings.
#
# base_cmd 'delete' delete_cmd
# nft_line/nft_base_cmd/nft_base_cmd_add/nft_base_cmd_add_set
#
################################################################################
# true positive test: properly hightlighted correctly; has good content; perfect
################################################################################


add table ip Tip

# delete table <table_spec>
# 'table'->delete_cmd->'delete'->base_cmd->line
delete table Tip


add table ip Tip
delete table ip Tip

add table ip6 Tip6
delete table ip6 Tip6

add table inet Tinet
delete table inet Tinet

add table netdev Tnetdev
delete table netdev Tnetdev

add table bridge Tbridge
delete table bridge Tbridge

add table arp Tarp
delete table arp Tarp

add table ip Tip2
add table ip6 Tip6_2
add table inet Tinet2
add table netdev Tnetdev2
add table bridge Tbridge2
add table arp Tarp2


# delete chain <chainid_spec>
# common_block->chain_block->'{'->'chain'->delete_cmd->'delete'->base_cmd->line
add table Tchain
add table ip TchainIp
add table ip6 TchainIp6
add table inet TchainInet
add table netdev TchainNetdev
add table bridge TchainBridge
add table arp TchainArp
add chain Tchain C1
add chain ip TchainIp C2
add chain ip6 TchainIp6 C3
add chain inet TchainInet C4
add chain netdev TchainNetdev C5
add chain bridge TchainBridge C6
add chain arp TchainArp C7

delete chain Tchain C1
delete chain ip TchainIp C2
delete chain ip6 TchainIp6 C3
delete chain inet TchainInet C4
delete chain netdev TchainNetdev C5
delete chain bridge TchainBridge C6
delete chain arp TchainArp C7

add chain Tchain C11
add chain Tchain C11
add chain ip TchainIp C12
add chain ip6 TchainIp6 C13
add chain inet TchainInet C14
add chain netdev TchainNetdev C15
add chain bridge TchainBridge C16
add chain arp TchainArp C17
delete chain Tchain C11 { }
delete chain ip TchainIp C12 {  }
delete chain ip6 TchainIp6 C13 {  }
delete chain inet TchainInet C14 {  }
delete chain netdev TchainNetdev C15 {  }
delete chain bridge TchainBridge C16 {  }
delete chain arp TchainArp C17 { }

add chain Tchain C
delete chain Tchain C { define my_var = 1; };


# TODO: Polish up the 'delete rule'
# delete rule <ruleid_spec>
#delete rule T C handle 16
#delete rule last C handle 16
#delete rule T last handle 16
#delete rule last last handle 16
#delete rule arp T C handle 16
#delete rule bridge T C handle 16
#delete rule filter output handle 5

#delete rule inet T C handle 16
#delete rule ip6 T C handle 16
#delete rule ip T C handle 42
#delete rule netdev T C handle 16
#delete rule T C handle 42



# delete set <set_spec>
add table T
add set T S { type ipv4_addr; elements = { 1.1.1.1 }; }
table ip Tip { set Sip1 { type ipv4_addr; elements = { 1.1.1.1 }; }; }
table ip6 Tip6 { set Sip6_1 { type ipv4_addr; elements = { 1.1.1.1 }; }; }
table inet Tinet { set Sinet { type ipv4_addr; elements = { 1.1.1.1 }; }; }
table netdev Tnetdev { set Snetdev { type ipv4_addr; elements = { 1.1.1.1 }; }; }
table bridge Tbridge { set Sbridge { type ipv4_addr; elements = { 1.1.1.1 }; }; }
table arp Tarp { set Sarp { type ipv4_addr; elements = { 1.1.1.1 }; }; }

delete set T S
delete set ip Tip Sip1
delete set ip6 Tip6 Sip6_1
delete set inet Tinet Sinet
delete set netdev Tnetdev Snetdev
delete set bridge Tbridge Sbridge
delete set arp Tarp Sarp

# delete map <map_spec>
add table T
#### add map T S { flags timeout; timeout 1h; type ipv4_addr : verdict; };
table ip Tip { map Sip1 { flags timeout; timeout 1h; type ipv4_addr : verdict; }; }
table ip6 Tip6 { map Sip6_1 { flags timeout; timeout 1h; type ipv6_addr : verdict; }; }
table inet Tinet { map Sinet { flags timeout; timeout 1h; type ipv4_addr : verdict; }; }
table bridge Tbridge { map Sbridge { flags timeout; timeout 1h; type ipv4_addr : verdict; }; }
table netdev Tnetdev { map Snetdev { flags timeout; timeout 1h; type ipv4_addr : verdict; }; }
table arp Tarp { map Sarp { flags timeout; timeout 1h; type ipv4_addr : verdict; }; }

#### delete map T S
delete map ip Tip Sip1
delete map ip6 Tip6 Sip6_1
delete map inet Tinet Sinet
delete map netdev Tnetdev Snetdev
delete map bridge Tbridge Sbridge
delete map arp Tarp Sarp

add table T;
add set T M { type inet_service; };
add set T M1 { type inet_service; };

# delete element <set_spec> <set_block_expr>
add table ip Tip
table ip Tip {
    chain filter { type filter hook input priority 0; }
    map action_map { flags timeout; timeout 1h; type ipv4_addr : verdict; }
}

# 'delete' 'flowtable' <flowtable_spec>
# common_block->flowtable_block->'{'->'flowtable'->delete_cmd->'delete'->base_cmd->line
# Add tables
add table ip T
add table ip Tip
add table ip6 Tip6
# Add flowtables
add flowtable ip T FT { hook ingress priority 15; devices = { eno2 }; }
add flowtable ip Tip FTip { hook ingress priority 0; devices = { eno2 }; }
add flowtable ip6 Tip6 FTip6 { hook ingress priority 0; devices = { eno2 }; }
add flowtable inet Tinet FTinet { hook ingress priority 0; devices = { eno2 }; }
# Delete flowtables (if needed)
delete flowtable ip T FT
delete flowtable ip Tip FTip
delete flowtable ip6 Tip6 FTip6
delete flowtable inet Tinet FTinet

# delete quota <obj_spec>
add table ip T
add table ip Tip
add table ip6 Tip6
add table inet Tinet
add table netdev Tnetdev
add table bridge Tbridge
add table arp Tarp
add quota T Q 500 mbytes
add quota ip Tip Qip over 500 mbytes
add quota ip6 Tip6 Qip6 until 500 mbytes
add quota inet Tinet Qinet until 500 mbytes
add quota netdev Tnetdev Qnetdev until 500 mbytes
add quota bridge Tbridge Qbridge until 500 mbytes
add quota arp Tarp Qarp until 500 mbytes
delete quota T Q
delete quota ip Tip Qip
delete quota ip6 Tip6 Qip6
delete quota inet Tinet Qinet
delete quota netdev Tnetdev Qnetdev
delete quota bridge Tbridge Qbridge
delete quota arp Tarp Qarp

# secmark commented out here in delete.tp.nft due to senforce=Disabled
# however, a copy remains in 'z-secmark.tp.nft' unit test.
#add table ip Tip
#add table ip6 Tip6
#add table inet Tinet
#add secmark ip Tip SMip { "system_u:object_r:ssh_server_packet_t:s0" }
#add secmark ip6 Tip6 SMip6 { "system_u:object_r:http_server_packet_t:s0" }  # fails, family_spec required
#add secmark inet Tinet SMinet { "system_u:object_r:dns_server_packet_t:s0" }
#delete secmark ip Tip SMip
#delete secmark ip6 Tip6 SMip6
#delete secmark inet Tinet SMinet

add table T
add table ip Tip
add table ip6 Tip6
add table inet Tinet

add synproxy T SP mss 1500 wscale 7;
add synproxy ip Tip SPip mss 1492 wscale 5;
add synproxy ip6 Tip6 SPip6 mss 1498 wscale 6;
add synproxy inet Tinet SPinet mss 1496 wscale 4;

delete synproxy T SP
delete synproxy ip Tip SPip
delete synproxy ip6 Tip6 SPip6
delete synproxy inet Tinet SPinet




