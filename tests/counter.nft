#!/usr/sbin/nft -f
# File: counter.nft
# Description: A test NFT file to exercise 'counter' keyword Vim syntax highlightings.
#
# bison symbol:   counter_stmt
# syntax pathway: counter_stmt->stateful_stmt->(stmt|stateful_stmt_list)
#
#
# First-Order, First-encountered keywords after 'counter' keyword
# Keyword  Type of stmt    Description
# log      log_stmt        Packet logging
# accept   verdict_stmt    Verdict: accept
# drop     verdict_stmt    Verdict: drop
# continue verdict_stmt    Verdict: continue
# jump     verdict_stmt    Control flow
# return   verdict_stmt    Return from chain
# meta     expr_stmt       Expression involving meta keys
# ip       expr_stmt       Match IP headers
# tcp      expr_stmt       Match TCP headers
# ct       stateful_stmt   Conntrack match or assignment
# limit    stateful_stmt   Rate limiting
# mark     expr_stmt or match_stmt    Firewall mark matching or assignment
# payload  expr_stmt       Match protocol payload
# quota    stateful_stmt   Match on bytes used
# set      set_stmt        Set element addition or update (in update-only rules)
# reject   verdict_stmt    ICMP/TCP rejection
# audit    log_stmt        Similar to log
# synproxy stateful_stmt   TCP SYN proxy setup
################################################################################
# true positive test: properly hightlighted correctly; has good content; perfect
################################################################################


add counter ip table_id counter_id packets 5 bytes 1500
add counter ip table_id counter_id packets 5 bytes 1500;
add counter ip table_id counter_id packets 5 bytes 1500;
add counter ip table_id counter_id packets 5 bytes 1500 ;
add counter ip table_id counter_id packets 5 bytes 1500 ;

# 'counter' as a statement ('stmt')
add counter table_id counter_id
add counter table_id counter_id;
add counter table_id counter_id;
add counter table_id counter_id ;
add counter table_id counter_id ;


add counter inet mytable my_counter_name


add counter table_id counter_id { comment "Nice to say things" }

add counter table_id counter_id { packets 5 bytes 1500 };
add counter table_id counter_id { packets 5 bytes 1500 };
add counter table_id counter_id { packets 5 bytes 1500 } ;
add counter table_id counter_id { packets 5 bytes 1500 } ;

add counter table_id counter_id { packets 5 bytes 1500 };
add counter table_id counter_id { packets 5 bytes 1500 } ;
add counter table_id counter_id { packets 5 bytes 1500 } ;

add counter table_id counter_id {
    define A = 1
    packets 5 bytes 1500
};

counter table_id counter_id
counter table_id counter_id; 
counter table_id counter_id ;
counter table_id counter_id ; 
counter last counter_id
counter table_id last
counter last last
counter ip table_id counter_id
counter ip6 table_id counter_id;
counter inet table_id counter_id ;
counter netdev table_id counter_id; 
counter bridge table_id counter_id ; 
counter arp table_id counter_id
counter arp last counter_id
counter arp table_id last
counter arp last counter_id
counter arp last last
counter bridge table_id counter_id name mycountername; 

counter table_id counter_id packets 5 bytes 1500
counter table_id counter_id packets 5 bytes 1500; 
counter table_id counter_id packets 5 bytes 1500 ;
counter table_id counter_id packets 5 bytes 1500 ; 

counter table_id counter_id { packets 5 bytes 1500 }; 
counter table_id counter_id { packets 5 bytes 1500;}; 
counter table_id counter_id { packets 5 bytes 1500; }; 
counter table_id counter_id { packets 5 bytes 1500 ; }; 
counter table_id counter_id { packets 5 bytes 1500 } ;
counter table_id counter_id { packets 5 bytes 1500 } ;
counter table_id counter_id { packets 5 bytes 1500 } ; 

# inline comment
counter table_id counter_id { 
    # inline comments
    define A = 1  # inline comments
    redefine A = 2  # inline comments
    undefine A  # inline comments
    error; 
    packets 5 bytes 1500  # inline comments
    include "global_firewall.nft";
    include "lou_s_firewall.nft"
    comment "this stuff!`~@#$%^&*()_+-={}[]|\\:\"<>?/";
};


# base_cmd add_cmd 'table' table_spec table_block 'counter' counter_block
table T { counter C { } }
table ip T { counter C { } }
table ip6 T { counter C { } }
table inet T { counter C { } }
table netdev T { counter C { } };
table netdev T { counter C { } } ;
table netdev T { counter C { } };
table netdev T { counter C { } } ;
table bridge T { counter C { } }
table arp T { counter C { } }
table T { counter C { packets 123 bytes 15 } }
table T {
    counter C {
        # common_block
        include "/directory/subdirectory/filename.filetype"
        define A = 1
        redefine A = 2
        undefine A
        packets 123 bytes 123;
        packets 123 bytes 123
    }
}



table inet mytable {
    comment "asdfasdfasdff"
    # table_block/common_block
    include "global_firewall.nft";
    # inline comments
    define A = 1  # inline comments
    redefine A = 2  # inline comments
    undefine A  # inline comments
    error; 
    # table_options
    flags dormant, persist, owner
    #counter { counter_config };
    # 'counter' keyword is under add_cmd->table_block->'counter'
    counter packets 123;  # THIS IS AN ERROR
    counter name my_counter_name;  # THIS IS AN ERROR
    counter C {
        # table_block/counter_block/comment_spec
        comment "comment part"
        # counter_config
        # table_block/common_block
        include "global_firewall.nft";
        packets 123
        bytes 123
        # inline comments
        define A = 1  # inline comments
        redefine A = 2  # inline comments
        undefine A  # inline comments
        error; 
    }
};

table inet mytable {
    chain mychain {
        # common_block
        include "global_firewall.nft";
        define A = 1  # inline comments
        redefine A = 2  # inline comments
        undefine A  # inline comments
        error; 
        # chain_block/flags_spec
        flags offload
        # chain_block/rule/rule_alloc/stmt/stateful_stmt/counter_stmt
        counter
        counter packets 123 bytes 123123
        # chain_block/rule/rule_alloc/stmt/objref_stmt/objref_stmt_counter
        counter name my_counter_name
        counter name my_counter_name;
        comment "asdfasdfasdff"
    };
};

# 'counter' as an expression ('expr')
# counter_stmt->stateful_stmt->stateful_stmt_list->set_spec
# counter_stmt->stateful_stmt->(stmt|stateful_stmt_list)

add set T S { counter }
add set T S { counter } ;

add set T S { counter bytes 2048 }
add set T S { counter packets 3 }

# repeated stateful_stmt
add set T S { counter packets 3 counter packets 3 }

delete counter T CC
delete counter ip T CC
delete counter ip6 T CC
delete counter inet T CC
delete counter netdev T CC
delete counter bridge T CC
delete counter arp T CC

delete counter T handle 1
delete counter ip T handle 1
delete counter ip6 T handle 1
delete counter inet T handle 1
delete counter netdev T handle 1
delete counter bridge T handle 1
delete counter arp T handle 1

destroy counter T CC
destroy counter ip T CC
destroy counter ip6 T CC
destroy counter inet T CC
destroy counter netdev T CC
destroy counter bridge T CC
destroy counter arp T CC

destroy counter T handle 1
destroy counter ip T handle 1
destroy counter ip6 T handle 1
destroy counter inet T handle 1
destroy counter netdev T handle 1
destroy counter bridge T handle 1
destroy counter arp T handle 1

list counter T C

reset counter T C

add table T {
    chain C {
        iif == "eth0" counter;
        counter name $MY_COUNTER_VARNAME;
        counter name "named_counter_identifier";
        counter name 'named_counter_identifier';
        counter name named_counter_identifier;
    }
};

# counter_stmt (used in rule/stmt and table-counter counter_block)
table T {
    counter last {
        # inline comments
        define A = 1  # inline comments
        redefine A = 2  # inline comments
        undefine A  # inline comments
        error; 
        include "global_firewall.nft";
        include "lou_s_firewall.nft"
        comment "this stuff!`~@#$%^&*()_+-={}[]|\\:\"<>?/";
    }
    counter name my_count;
} ;

################################################################################
# true negative test: properly hightlighted wrongly to show an error; 
# so far, so good.
################################################################################

counterT ;

counter 


counter T 


counter T ; 

counter ip6tableid 


counter ip6 tableid counter_id

add counter table_id counter_id { 
    define ABC = 1;
    comment "aasdfasdf"
    packets5bytes1500 
} ;
add counter table_id counter_id { 
    define ABC = 1;
    packets5bytes1500 
} ;
add counter ip table_id counter_id { 
    define ABC = 1;
    packets5 bytes 1500 ;
};
add counter ip table_id counter_id { 
    define ABC = 1;
    packets 5bytes 1500 ;
};
add counter ip table_id counter_id { 
    packets 5 bytes1500 
};

add rule table_id chain_id set add { $MYVAR counter at  };

add counter table_id counter_id { packets5bytes1500 } ;
add counter ip table_id counter_id { packets5 bytes 1500 ; };
add counter ip table_id counter_id { packets 5bytes 1500 ; };
add counter ip table_id counter_id { packets 5 bytes1500 };

add set T S { counter marshmellows }
add set T S { counter bytes mss }
add set T S { counter packets once }


################################################################################
# false negative test: highlighted wrongly; still has good content; oops.
################################################################################

add counter ip table_id counter_id packets5 bytes 1500 ;
add counter ip table_id counter_id packets 5bytes 1500 ;
add counter ip table_id counter_id packets 5 bytes1500;
add counter ip table_id counter_id packets 5 bytes1500 ;
add counter ip table_id counter_id packets 5 bytes1500 ;

add rule inet mytable mychain counter;
add rule inet mytable mychain counter name my_counter_name;
add rule inet mytable mychain counter name 'my_counter_name';
add rule inet mytable mychain counter name "my_counter_name";
add rule inet mytable mychain counter name $MY_COUNTER_VARNAME;

add counter ip table_id counter_id { packets 5 bytes 1500 ;





add counter ip t c { }  # it took a closing brace to turn off syntax error


################################################################################
# false positive test: looks highlighted correctly; has bad content; oops.
################################################################################

